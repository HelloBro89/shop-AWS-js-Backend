{"version":3,"file":"handler/catalogBatchProcess.js","mappings":"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","sources":["webpack://product-service/webpack/bootstrap","webpack://product-service/webpack/runtime/compat get default export","webpack://product-service/webpack/runtime/define property getters","webpack://product-service/webpack/runtime/hasOwnProperty shorthand","webpack://product-service/webpack/runtime/make namespace object","webpack://product-service/external \"aws-sdk\"","webpack://product-service/external \"pg\"","webpack://product-service/./handler/connection/connection.js","webpack://product-service/./handler/catalogBatchProcess.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"aws-sdk\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"pg\");","import PG from 'pg';\r\nconst { Client } = PG;\r\n\r\nconst { PG_HOST, PG_PORT, PG_DATABASE, PG_USERNAME, PG_PASSWORD } = process.env;\r\n\r\nconst dbOptions = {\r\n   host: PG_HOST,\r\n   port: PG_PORT,\r\n   database: PG_DATABASE,\r\n   user: PG_USERNAME,\r\n   password: PG_PASSWORD,\r\n   ssl: {\r\n      rejectUnauthorized: false\r\n   },\r\n   connectionTimeoutMillis: 5000\r\n};\r\n\r\nexport {dbOptions, Client}","import { SNS } from 'aws-sdk';\r\nimport { dbOptions, Client } from './connection/connection'\r\n\r\nexport const catalogBatchProcess = async (event) => {\r\n    \r\n    const client = new Client(dbOptions);\r\n    await client.connect();\r\n    console.log(`******CHECK EVENT  ${JSON.stringify(event)}`);\r\n    const items = await event.Records.map(({body}) => body );\r\n    let resFromSns;\r\n\r\n    try {\r\n        for (let item of items) {\r\n            const { price, title, description, count } = JSON.parse(item);\r\n    \r\n            if (!price || !title || !description || !count) {\r\n                throw new Error(`Product data is invalid`);\r\n            };\r\n            await client.query('BEGIN');\r\n            const addReqToProductDB = `insert into products (title, description, price ) values ('${title}', '${description}', ${price}) returning id`;\r\n            const resFromProductDB = await client.query(addReqToProductDB);\r\n            const primaryKeyID = resFromProductDB.rows[0].id;\r\n            const addReqToStockDB =  `insert into stocks (product_id, count ) values ('${primaryKeyID}', ${count})`;\r\n            await client.query(addReqToStockDB);\r\n            await client.query('COMMIT');\r\n    \r\n            const sns = new SNS({region: 'eu-west-1'});\r\n\r\n            const filteredPrice = (Number(price) > 999) ? 'moreThousand' : 'lessThousand';\r\n\r\n            console.log(`******CHECK RESULT ${filteredPrice}`);\r\n            const params = {\r\n                Subject: 'Products have been created in your DB',\r\n                Message: `${JSON.stringify(item)}`,\r\n                TopicArn: process.env.SNS_ARN,\r\n                MessageAttributes: {\r\n                    price: {\r\n                        DataType: 'String',\r\n                        StringValue: filteredPrice,\r\n                    }\r\n                }\r\n            };\r\n\r\n         resFromSns = await sns.publish(params).promise();\r\n    }\r\n        return {\r\n            statusCode: 200,\r\n            headers: {\r\n                'Access-Control-Allow-Origin': '*',\r\n                'Access-Control-Allow-Credentials': true,\r\n            },\r\n            body: JSON.stringify({\r\n                message: resFromSns,\r\n            }),\r\n        };\r\n        \r\n\r\n    } catch (e) {\r\n        // console.log(`*****ERROR MESSAGE: ${e.message}`);\r\n        // console.log(`*****ERROR NAME: ${e.name}`);\r\n        await client.query('ROLLBACK');\r\n        if (e.message === 'Product data is invalid') {\r\n            console.log(\"*****Error SyntaxError: \", e);\r\n            return {\r\n                statusCode: 400,\r\n                headers: {\r\n                    'Access-Control-Allow-Origin': '*',\r\n                    'Access-Control-Allow-Credentials': true,\r\n            },\r\n            body: JSON.stringify({message: \"Product data is invalid\"}),\r\n        };\r\n        } else {\r\n            console.log(\"*****Error status 500: Unexpected error: \", e);\r\n            return {\r\n                statusCode: 500,\r\n                headers: {\r\n                    'Access-Control-Allow-Origin': '*',\r\n                    'Access-Control-Allow-Credentials': true,\r\n                 },\r\n                 body: JSON.stringify({\r\n                 message: \"Unexpected error\"\r\n                }),\r\n            };\r\n        };\r\n    } finally {\r\n        client.end();\r\n    }\r\n\r\n};\r\n\r\n\r\n\r\n"],"names":["PG","Client","PG_HOST","PG_PORT","PG_DATABASE","PG_USERNAME","PG_PASSWORD","process","env","dbOptions","host","port","database","user","password","ssl","rejectUnauthorized","connectionTimeoutMillis","SNS","catalogBatchProcess","event","client","connect","console","log","JSON","stringify","items","Records","map","body","resFromSns","item","price","title","description","count","parse","Error","query","addReqToProductDB","resFromProductDB","primaryKeyID","rows","id","addReqToStockDB","sns","region","filteredPrice","Number","params","Subject","Message","TopicArn","SNS_ARN","MessageAttributes","DataType","StringValue","publish","promise","statusCode","headers","message","e","end"],"sourceRoot":""}